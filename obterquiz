// Função de Exportação
function exportarQuiz() {
    const quizData = {
        titulo: document.querySelector('input[name="titulo"]').value,
        tituloAbreviado: document.querySelector('input[name="titulo_abreviado"]').value,
        numeroQuestoes: document.querySelectorAll('textarea[name="pergunta"]').length,
        questoes: []
    };

    const perguntas = document.querySelectorAll('textarea[name="pergunta"]');
    const respostas = document.querySelectorAll('textarea[name^="resposta"]');
    const radios = document.querySelectorAll('input[type="radio"]');

    perguntas.forEach((pergunta, i) => {
        const questao = {
            pergunta: pergunta.value,
            respostas: [],
            correta: null
        };

        for (let j = 0; j < 5; j++) {
            const respostaIndex = (i * 5) + j;
            if (respostas[respostaIndex]) {
                questao.respostas.push(respostas[respostaIndex].value);
            }
        }

        for (let j = 0; j < 4; j++) {
            const radioIndex = (i * 4) + j;
            if (radios[radioIndex] && radios[radioIndex].checked) {
                questao.correta = j;
            }
        }

        quizData.questoes.push(questao);
    });

    const blob = new Blob([JSON.stringify(quizData)], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `${quizData.tituloAbreviado}.json`;
    a.click();
    URL.revokeObjectURL(url);
}

// Função de Importação
function importarQuiz() {
    const input = document.createElement("input");
    input.type = "file";
    input.accept = "application/json";

    input.addEventListener("change", (event) => {
        const file = event.target.files[0];
        if (!file) return;

        const reader = new FileReader();
        reader.onload = (e) => {
            const quizData = JSON.parse(e.target.result);

            // Preencher os títulos
            document.querySelector('input[name="titulo"]').value = quizData.titulo;
            document.querySelector('input[name="titulo_abreviado"]').value = quizData.tituloAbreviado;

            // Verifica o número de questões já criadas na página
            const numeroDeQuestoesCriadas = document.querySelectorAll('textarea[name="pergunta"]').length;

            // Criar as questões restantes
            const questoesFaltando = quizData.numeroQuestoes - numeroDeQuestoesCriadas;

            function criarProximaQuestao(faltando) {
                if (faltando > 0) {
                    document.querySelector("#criar-pergunta").click();
                    setTimeout(() => criarProximaQuestao(faltando - 1), 500); // Espera 500ms antes de criar a próxima questão
                } else {
                    preencherQuestoes(quizData);
                }
            }

            // Criar questões se necessário
            if (questoesFaltando > 0) {
                criarProximaQuestao(questoesFaltando);
            } else {
                preencherQuestoes(quizData);
            }
        };

        reader.readAsText(file);
    });

    input.click();
}

// Função para preencher as questões após todas terem sido criadas
function preencherQuestoes(quizData) {
    setTimeout(() => {
        const perguntas = document.querySelectorAll('textarea[name="pergunta"]');
        const respostas = document.querySelectorAll('textarea[name^="resposta"]');
        const radios = document.querySelectorAll('input[type="radio"]');

        quizData.questoes.forEach((questao, i) => {
            if (perguntas[i]) perguntas[i].value = questao.pergunta;

            questao.respostas.forEach((resposta, j) => {
                const respostaIndex = (i * 5) + j;
                if (respostas[respostaIndex]) respostas[respostaIndex].value = resposta;
            });

            if (questao.correta !== null) {
                const radioIndex = (i * 4) + questao.correta;
                if (radios[radioIndex]) radios[radioIndex].checked = true;
            }
        });

        // Salvar todas as questões
        setTimeout(() => {
            document.querySelectorAll(".salvar-pergunta").forEach(botao => botao.click());
        }, 1000);

    }, 2000); // Tempo extra para garantir que os campos foram criados antes do preenchimento
}

// Criar botões para exportar/importar
const containerBotoes = document.createElement("div");
containerBotoes.style.position = "fixed";
containerBotoes.style.top = "10px";
containerBotoes.style.left = "10px";
containerBotoes.style.zIndex = "9999";
document.body.appendChild(containerBotoes);

const btnExportar = document.createElement("button");
btnExportar.textContent = "Exportar Quiz";
btnExportar.style.padding = "10px";
btnExportar.style.marginRight = "10px";
btnExportar.addEventListener("click", exportarQuiz);
containerBotoes.appendChild(btnExportar);

const btnImportar = document.createElement("button");
btnImportar.textContent = "Importar Quiz";
btnImportar.style.padding = "10px";
btnImportar.addEventListener("click", importarQuiz);
containerBotoes.appendChild(btnImportar);

// Botão para mostrar/ocultar os botões
const btnToggle = document.createElement("button");
btnToggle.textContent = "Mostrar/Ocultar Botões";
btnToggle.style.padding = "10px";
btnToggle.style.marginLeft = "10px";
btnToggle.addEventListener("click", function () {
    const botoes = [btnExportar, btnImportar];
    botoes.forEach(botao => {
        botao.style.display = botao.style.display === "none" ? "inline-block" : "none";
    });
});
containerBotoes.appendChild(btnToggle);
